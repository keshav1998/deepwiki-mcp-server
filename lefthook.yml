# ğŸ¦€ Lefthook Configuration for DeepWiki MCP Server
# Fast, parallel Git hooks management replacing shell scripts and pre-commit
# Comprehensive quality checks for Rust projects with YAML configuration

min_version: 1.7.0

# ğŸš€ Pre-commit hooks - run before each commit
pre-commit:
  parallel: true
  commands:
    # ğŸ¨ Code formatting check
    fmt:
      run: cargo fmt --all --check
      glob: ["./crates/**/*", "./.github/**/*"]
      fail_text: |
        âŒ Code formatting failed!
        ğŸ’¡ Run 'cargo fmt' to fix formatting issues

    # ğŸ”§ Linting with strict warnings
    clippy:
      run: cargo clippy --all-targets --all-features -- -D warnings
      glob: ["./crates/*"]
      fail_text: |
        âŒ Clippy linting failed!
        ğŸ’¡ Fix the clippy warnings above before committing

    # âœ… Compilation check
    check:
      run: cargo check --all-targets --all-features
      glob: ["./crates/*"]
      fail_text: |
        âŒ Compilation check failed!
        ğŸ’¡ Fix the compilation errors above

    # ğŸ§ª Test execution
    test:
      run: cargo test --all-targets --all-features
      glob: ["./crates/*"]
      fail_text: |
        âŒ Tests failed!
        ğŸ’¡ Fix failing tests before committing

    # ğŸ“ YAML/TOML validation
    config-check:
      run: |
        # Check YAML files
        for file in *.yml *.yaml **/*.yml **/*.yaml; do
          [[ -f "$file" ]] || continue
          if command -v yq &> /dev/null; then
            yq eval . "$file" > /dev/null || exit 1
          elif python3 -c "import yaml" 2>/dev/null; then
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          fi
        done
        # Check TOML files
        for file in *.toml **/*.toml; do
          [[ -f "$file" ]] || continue
          if command -v taplo &> /dev/null; then
            taplo check "$file" || exit 1
          elif python3 -c "import tomllib" 2>/dev/null; then
            python3 -c "import tomllib; tomllib.load(open('$file', 'rb'))" || exit 1
          fi
        done
      glob: ["./.github/*.{yml,yaml,toml}", "./crates/*.{yml,yaml,toml}"]
      fail_text: |
        âŒ Configuration file validation failed!
        ğŸ’¡ Check YAML/TOML syntax in the files above

    # ğŸ§¹ Trailing whitespace check
    trailing-whitespace:
      run: |
        if grep -rn '[[:space:]]$' --include="*.rs" --include="*.yml" --include="*.yaml" --include="*.toml" --include="*.md" .; then
          echo "âŒ Trailing whitespace found in files above!"
          exit 1
        fi
      glob:
        [
          "./.github/*.{rs,yml,yaml,toml,md,sh}",
          "./crates/*.{rs,yml,yaml,toml,md,sh}",
        ]
      fail_text: |
        âŒ Trailing whitespace detected!
        ğŸ’¡ Remove trailing whitespace from the files listed above

    # ğŸ”’ Security: Check for hardcoded secrets
    secrets-check:
      run: |
        # Check for potential secrets in staged files
        if grep -rn -E "(api_?key|secret|password|token|credential).*[=:]\s*[\"'][^\"']{8,}[\"']" \
           --include="*.rs" --include="*.toml" --include="*.yml" --include="*.yaml" .; then
          echo "âŒ Potential hardcoded secrets found!"
          echo "ğŸ’¡ Remove hardcoded credentials and use environment variables"
          exit 1
        fi
      glob: ["./.github/*.{rs,toml,yml,yaml}", "./crates/*.{rs,toml,yml,yaml}"]
      fail_text: |
        âŒ Potential secrets detected!
        ğŸ’¡ Remove hardcoded credentials from the files above

    # ğŸ“¦ Cargo.toml validation
    cargo-check:
      run: cargo metadata --format-version 1 > /dev/null
      glob: "./Cargo.toml"
      fail_text: |
        âŒ Cargo.toml validation failed!
        ğŸ’¡ Check Cargo.toml syntax and dependencies

# ğŸš¢ Pre-push hooks - run before pushing to remote
pre-push:
  parallel: true
  commands:
    # ğŸ” Full workspace validation
    workspace-check:
      run: cargo check --workspace --all-targets --all-features
      glob: ["./crates/"]
      fail_text: |
        âŒ Full workspace check failed!
        ğŸ’¡ Fix compilation errors before pushing

    # ğŸ§ª Complete test suite
    full-test:
      run: cargo test --workspace --all-targets --all-features --verbose
      glob:
        - "./crates/"
      fail_text: |
        âŒ Full test suite failed!
        ğŸ’¡ All tests must pass before pushing

    # ğŸ“š Documentation check
    doc-check:
      run: cargo doc --no-deps --all-features --document-private-items
      glob: ["./crates/", "./.github/"]
      fail_text: |
        âŒ Documentation generation failed!
        ğŸ’¡ Fix documentation errors and missing docs

    # ğŸ”§ Clippy pedantic mode for thorough analysis
    clippy-pedantic:
      run: cargo clippy --all-targets --all-features -- -W clippy::pedantic -W clippy::nursery -D warnings
      glob: ["./crates/", "./.github/"]
      fail_text: |
        âŒ Pedantic clippy check failed!
        ğŸ’¡ Address additional clippy suggestions for code quality

# ğŸ“ Commit message validation (temporarily disabled)
# commit-msg:
#   commands:
#     # ğŸ¨ Emoji commits format
#     emoji-commit:
#       run: |
#         # Read commit message from the file passed as argument
#         if [ -z "$1" ] || [ ! -f "$1" ]; then
#           echo "âŒ No commit message file provided"
#           exit 1
#         fi
#
#         commit_msg=$(head -1 "$1")
#
#         # Skip merge commits
#         if echo "$commit_msg" | grep -q "^Merge "; then
#           exit 0
#         fi
#
#         # Check emoji commits format - starts with emoji followed by space and description
#         emoji_regex='^[ğŸ¨ğŸ›ğŸ“ğŸ’„â™»ï¸âš¡ğŸ”¥ğŸ’šâœ…ğŸ”’ğŸ”–ğŸš¨ğŸš§ğŸ’©â¬†ï¸â¬‡ï¸ğŸ“ŒğŸ‘·ğŸ“ˆğŸ³ğŸ”§ğŸŒğŸ’«ğŸ—‘ï¸ğŸ”€ğŸ“¦ğŸ‘½ğŸ“„ğŸ’¡ğŸ±â™¿ğŸ’¬ğŸ¥…ğŸ©¹ğŸ—ï¸ğŸ·ï¸ğŸŒ±ğŸš©ğŸ’€ğŸ‘¥] .{1,80}'
#
#         if ! echo "$commit_msg" | grep -qE "$emoji_regex"; then
#           echo "âŒ Invalid commit message format!"
#           echo ""
#           echo "ğŸ“‹ Use emoji commits format:"
#           echo "   emoji description"
#           echo ""
#           echo "ğŸ¯ Common emojis:"
#           echo "   ğŸ¨ - Improve structure/format of code"
#           echo "   ğŸ› - Fix a bug"
#           echo "   ğŸ“ - Add or update documentation"
#           echo "   ğŸ’„ - Add or update UI/UX"
#           echo "   â™»ï¸  - Refactor code"
#           echo "   âš¡ - Improve performance"
#           echo "   ğŸ”¥ - Remove code or files"
#           echo "   ğŸ’š - Fix CI build"
#           echo "   âœ… - Add, update, or pass tests"
#           echo "   ğŸ”’ - Fix security issues"
#           echo "   ğŸ”§ - Add or update config files"
#           echo "   ğŸš€ - Deploy stuff"
#           echo "   ğŸ“¦ - Add or update compiled files"
#           echo ""
#           echo "ğŸ“ Examples:"
#           echo "   ğŸ¨ improve code structure and formatting"
#           echo "   ğŸ› fix connection timeout issue"
#           echo "   ğŸ“ update installation documentation"
#           echo "   âœ… add unit tests for validation"
#           exit 1
#         fi
#       fail_text: |
#         âŒ Commit message validation failed!
#         ğŸ’¡ Use emoji commits format described above

# âš™ï¸ Global settings
skip_output:
  - meta
  - execution_out

output:
  - summary
  - success
  - failure

# ğŸ¯ Performance and behavior settings
assert_lefthook_installed: true
no_tty: false
